name: test-output

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  run-test-output:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Ensure Git LFS files are present
        run: |
          git lfs version
          git lfs pull

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Debug GROQ_API_KEY presence (safe)
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          if [ -z "$GROQ_API_KEY" ]; then
            echo "GROQ_API_KEY is EMPTY"
          else
            echo "GROQ_API_KEY is SET"
          fi

      # Optional: sanity-check that your FAISS index isn't an LFS pointer file.
      # Set INDEX_PATH to your actual index file location in the repo.
      - name: Debug FAISS index header (safe)
        env:
          INDEX_PATH: pmc_faiss.index
        run: |
          python - << 'PY'
          from pathlib import Path
          p = Path("${INDEX_PATH}")
          if not p.exists():
              print(f"[WARN] Index file not found at: {p.resolve()}")
          else:
              head = p.read_bytes()[:80]
              text = head.decode("utf-8", errors="replace")
              print("[INFO] First 80 bytes:")
              print(text)
              if text.startswith("version https://git-lfs.github.com/spec"):
                  raise SystemExit("[FAIL] Index is still a Git LFS pointer. LFS pull failed.")
          PY

      - name: Run test-output script
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          python test-output/test_output.py

      - name: Upload test artifacts (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-output
          path: |
            test-output/test_output.json
            test-output/test_output.log
          if-no-files-found: ignore
